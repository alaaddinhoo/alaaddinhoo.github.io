<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amazon IVS Real-Time Streaming Web Sample</title>

    <!-- Fonts and Styling -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css"
    />

    <!-- Stages in Broadcast SDK -->
    <script src="https://web-broadcast.live-video.net/1.19.0/amazon-ivs-web-broadcast.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body,
      html {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #remote-media {
        width: 100%;
        height: 100%;
        position: relative;
      }

      video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #loading-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 1rem 2rem;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div id="remote-media">
      <p id="loading-message">Loading the stream...</p>
    </div>

    <!-- JavaScript to manage streaming -->
    <script>
      const { Stage, SubscribeType, StageEvents, ConnectionState, StreamType } =
        IVSBroadcastClient;

      let stage;
      let connected = false;

      // Helper function to create video element for participants
      function setupParticipant({ id }) {
        const groupContainer = document.getElementById("remote-media");
        const videoEl = createVideoEl(id);
        groupContainer.appendChild(videoEl);
        return videoEl;
      }

      // Helper function to teardown participant video element
      function teardownParticipant({ id }) {
        const groupContainer = document.getElementById("remote-media");
        const videoEl = document.getElementById(id);
        if (videoEl) {
          groupContainer.removeChild(videoEl);
        }
      }

      function createVideoEl(id) {
        const videoEl = document.createElement("video");
        videoEl.id = id;
        videoEl.autoplay = true;
        videoEl.playsInline = true;
        videoEl.muted = true; // Start muted to allow autoplay
        videoEl.controls = true; // Add controls for unmute/volume adjustment
        return videoEl;
      }

      // Join Stage Function
      const joinStage = async (token) => {
        if (!token) {
          document.getElementById("loading-message").textContent =
            "Token is missing. Cannot join the stage.";
          return;
        }

        stage = new Stage(token, {
          stageStreamsToPublish: () => [],
          shouldPublishParticipant: () => false, // No need to publish media, only view
          shouldSubscribeToParticipant: () => SubscribeType.AUDIO_VIDEO,
        });

        stage.on(StageEvents.STAGE_CONNECTION_STATE_CHANGED, (state) => {
          connected = state === ConnectionState.CONNECTED;
        });

        stage.on(
          StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED,
          (participant, streams) => {
            if (!participant.isLocal) {
              const videoEl = setupParticipant(participant);
              streams.forEach((stream) => {
                if (stream.streamType === StreamType.VIDEO) {
                  console.log("Stream details:", stream);
                  if (stream.mediaStreamTrack) {
                    const mediaStream = new MediaStream([
                      stream.mediaStreamTrack,
                    ]);

                    // Add audio track if it exists
                    const audioTrack = streams.find(
                      (s) => s.streamType === StreamType.AUDIO
                    )?.mediaStreamTrack;
                    if (audioTrack) {
                      mediaStream.addTrack(audioTrack);
                    }

                    videoEl.srcObject = mediaStream;

                    // Attempt to play the video and handle unmute
                    videoEl
                      .play()
                      .then(() => {
                        console.log("Video playback started");
                        videoEl.muted = true; // Keep muted initially
                      })
                      .catch((err) => {
                        console.error("Error starting video playback", err);
                        alert(
                          "Please interact with the page to start video playback."
                        );
                      });

                    // Allow unmuting after user interaction
                    videoEl.addEventListener("click", () => {
                      videoEl.muted = false; // Unmute
                      videoEl.volume = 1.0; // Set volume to max
                    });
                  } else {
                    console.error("No mediaStreamTrack found in the stream.");
                  }
                }
              });
              document.getElementById("loading-message").style.display = "none";
            }
          }
        );

        stage.on(StageEvents.STAGE_PARTICIPANT_LEFT, (participant) => {
          teardownParticipant(participant);
        });

        try {
          await stage.join();
          document.getElementById("loading-message").textContent =
            "Stream loaded successfully!";
        } catch (err) {
          console.error(err.message);
          document.getElementById("loading-message").textContent =
            "Error loading stream.";
        }
      };

      // Function to get the token from URL query parameters
      const getTokenFromUrl = () => {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("token");
      };

      // Automatically join the stage when the page loads
      window.addEventListener("DOMContentLoaded", () => {
        const token = getTokenFromUrl();
        if (token) {
          joinStage(token);
        } else {
          document.getElementById("loading-message").textContent =
            "Token is missing. Cannot join the stage.";
        }
      });
    </script>
  </body>
</html>
